import{r as i,j as e}from"./index-Bhhhx7h4.js";import{A as C,T as D}from"./index-D9_lrgu6.js";import{F as g,I as L}from"./index-IivWOIOz.js";import{M}from"./index-DsxaOx6h.js";import{B as p}from"./button-DgkAoqE2.js";import{S as u}from"./index-Bjxa92qe.js";import{A as S}from"./index-DIL_-TYb.js";import{S as b}from"./index-_rPoQdzz.js";const{Text:r,Title:O}=D;function Y({isOpen:T,onClose:f,courseId:v,courseTitle:x,amount:P,onSuccess:h,onError:o,type:m="COURSE_PURCHASE"}){const[y]=g.useForm(),[w,j]=i.useState(!1),[l,F]=i.useState(null),[a,n]=i.useState("form"),[W,A]=i.useState(0),[k,I]=i.useState(!1),{mutateAsync:N}=C.fapshi.initiatePayment.useMutation(),{data:c,refetch:d}=C.fapshi.getPaymentStatus.useQuery({transId:l||""},{enabled:!!l});i.useEffect(()=>{let t,s;return a==="pending"&&l&&(d(),t=setInterval(()=>{d(),A(B=>B+1)},3e4),s=setTimeout(()=>{a==="pending"&&(clearInterval(t),n("timeout"))},30*60*1e3)),()=>{t&&clearInterval(t),s&&clearTimeout(s)}},[a,l,d]),i.useEffect(()=>{if(c&&typeof c=="object"&&"status"in c){const t=c;t.status==="SUCCESSFUL"?(n("success"),h()):t.status==="FAILED"?(n("failed"),o("Payment failed. Please try again.")):t.status}},[c,h,o,a]);const U=async t=>{j(!0);try{const s=await N({amount:parseFloat(P),phone:t.phoneNumber,message:`Payment for ${m==="SUBSCRIPTION"?"Premium Subscription":"Course"}: ${x}`,type:m,referenceId:v});F(s.transactionId),n("pending")}catch(s){o(s.message||"Failed to process payment")}finally{j(!1)}},R=async()=>{I(!0);try{const t=await d();if(t&&typeof t=="object"&&"status"in t){const s=t;s.status==="SUCCESSFUL"?(n("success"),h()):s.status==="FAILED"?(n("failed"),o("Payment failed. Please try again.")):n("pending")}}catch{n("failed"),o("Error checking payment status")}finally{I(!1)}},E=()=>{switch(a){case"form":return e.jsx(g,{form:y,onFinish:U,layout:"vertical",children:e.jsx(g.Item,{name:"phoneNumber",label:"Phone Number",rules:[{required:!0,message:"Please enter phone number"},{pattern:/^(237|\+237)?[6-9][0-9]{8}$/,message:"Please enter a valid Cameroon phone number"}],children:e.jsx(L,{addonBefore:"+237"})})});case"pending":return e.jsxs(u,{direction:"vertical",align:"center",style:{width:"100%"},children:[e.jsx(b,{size:"large"}),e.jsx(O,{level:4,children:"Waiting for Payment Confirmation"}),e.jsx(r,{type:"secondary",children:"Please check your phone and confirm the payment request"}),e.jsxs(u,{direction:"vertical",style:{width:"100%",marginTop:24},children:[e.jsx(S,{message:"Payment Details",description:e.jsxs(u,{direction:"vertical",children:[e.jsxs(r,{children:[m==="SUBSCRIPTION"?"Subscription":"Course",": ",x]}),e.jsxs(r,{children:["Amount: ",P," XAF"]}),e.jsxs(r,{children:["Phone: ",y.getFieldValue("phoneNumber")]}),e.jsxs(r,{children:["Transaction ID: ",l]})]}),type:"info",showIcon:!0}),e.jsxs("div",{style:{textAlign:"center",marginTop:16},children:[e.jsx(b,{size:"small"}),e.jsx(r,{type:"secondary",style:{marginLeft:8},children:"Checking payment status..."})]})]})]});case"timeout":return e.jsxs(u,{direction:"vertical",align:"center",style:{width:"100%"},children:[e.jsx(S,{message:"Payment Status Unclear",description:"We couldn't confirm your payment status. Would you like to check again?",type:"warning",showIcon:!0}),e.jsx(p,{type:"primary",onClick:R,loading:k,style:{marginTop:16},children:"Check Status Again"})]});case"failed":return e.jsxs(u,{direction:"vertical",align:"center",style:{width:"100%"},children:[e.jsx(S,{message:"Payment Failed",description:"Your payment could not be processed. Please try again.",type:"error",showIcon:!0}),e.jsx(p,{type:"primary",danger:!0,onClick:f,style:{marginTop:16},children:"Close"})]});default:return null}};return e.jsx(M,{open:T,onCancel:f,footer:a==="form"?[e.jsx(p,{onClick:f,children:"Cancel"},"cancel"),e.jsx(p,{type:"primary",onClick:()=>y.submit(),loading:w,children:"Pay Now"},"submit")]:null,width:500,title:m==="SUBSCRIPTION"?"Premium Subscription Payment":"Course Payment",children:E()})}export{Y as C};

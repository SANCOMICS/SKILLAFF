import{r,j as e}from"./index-Bhhhx7h4.js";import{u as $}from"./useUserContext-CjczNUYd.js";import{A as g,T as W}from"./index-D9_lrgu6.js";import{u as z}from"./index-CeUTncnb.js";import{F as S,I as C}from"./index-IivWOIOz.js";import{M as X}from"./index-DsxaOx6h.js";import{B as u}from"./button-DgkAoqE2.js";import{S as y}from"./index-Bjxa92qe.js";import{A as w}from"./index-DIL_-TYb.js";import{S as F}from"./index-_rPoQdzz.js";import{R as q,C as A}from"./row-DHszOpHb.js";import{C as T}from"./index-ydtyDG1o.js";import{F as O}from"./Table-DELuyHK0.js";import{s as k}from"./index-DaEJ5rVL.js";import{P as Q}from"./index-ufwEpZVH.js";import"./index-Bs36QOeU.js";import"./pickAttrs-r0RFaJBP.js";import"./SearchOutlined-CdaQ9A1C.js";import"./collapse-BbEVqHco.js";import"./ExclamationCircleFilled-CiuxUjGk.js";import"./CloseOutlined-Dxm4jkL9.js";import"./useClosable-CCDYGg12.js";import"./Dropdown-DVbf8yOU.js";import"./fade-2t19LHl3.js";import"./responsiveObserver-Cz69L87y.js";import"./index-CeoCv33H.js";import"./EllipsisOutlined-D3hTA01Z.js";import"./Pagination-CBJzwpBi.js";import"./LeftOutlined-R_ycQdco.js";import"./useBreakpoint-D4cuiZ4X.js";import"./index-Hz7ZMWx3.js";import"./index-rKHRpc2j.js";import"./Sider-C8x-a6eO.js";const{Text:f,Title:G}=W;function v({isOpen:n,onClose:p,type:d,onSuccess:m,onError:o}){z();const[l]=S.useForm(),[b,x]=r.useState(!1),[c,j]=r.useState(null),[i,s]=r.useState("form"),[K,M]=r.useState(0),[N,P]=r.useState(!1),{mutateAsync:E}=g.billing.initiateDeposit.useMutation(),{mutateAsync:L}=g.billing.processWithdrawal.useMutation(),{data:h,refetch:I}=g.fapshi.getPaymentStatus.useQuery({transId:c||""},{enabled:!!c});r.useEffect(()=>{let t,a;return i==="pending"&&c&&(I(),t=setInterval(()=>{I(),M(B=>B+1)},3e4),a=setTimeout(()=>{i==="pending"&&(clearInterval(t),s("timeout"))},30*60*1e3)),()=>{t&&clearInterval(t),a&&clearTimeout(a)}},[i,c,I]),r.useEffect(()=>{h&&(h.status==="SUCCESSFUL"?(s("success"),m()):h.status==="FAILED"?(s("failed"),o("Payment failed. Please try again.")):h.status)},[h,m,o,i]);const R=async t=>{x(!0);try{if(d==="deposit"){const a=await E({amount:t.amount,phoneNumber:t.phoneNumber});j(a),s("pending")}else await L({amount:t.amount,phoneNumber:t.phoneNumber}),m()}catch(a){o(a.message||"Failed to process payment")}finally{x(!1)}},U=async()=>{P(!0);try{const t=await I();(t==null?void 0:t.status)==="SUCCESSFUL"?(s("success"),m()):(t==null?void 0:t.status)==="FAILED"?(s("failed"),o("Payment failed. Please try again.")):s("pending")}catch{s("failed"),o("Error checking payment status")}finally{P(!1)}},V=()=>{switch(i){case"form":return e.jsxs(S,{form:l,onFinish:R,layout:"vertical",children:[e.jsx(S.Item,{name:"amount",label:"Amount",rules:[{required:!0,message:"Please enter amount"},{pattern:/^\d+$/,message:"Please enter a valid amount"},{validator:(t,a)=>a&&parseInt(a)<=0?Promise.reject("Amount must be greater than 0"):Promise.resolve()}],children:e.jsx(C,{prefix:"XAF"})}),e.jsx(S.Item,{name:"phoneNumber",label:"Phone Number",rules:[{required:!0,message:"Please enter phone number"},{pattern:/^(237|\+237)?[6-9][0-9]{8}$/,message:"Please enter a valid Cameroon phone number"}],children:e.jsx(C,{addonBefore:"+237"})})]});case"pending":return e.jsxs(y,{direction:"vertical",align:"center",style:{width:"100%"},children:[e.jsx(F,{size:"large"}),e.jsx(G,{level:4,children:"Waiting for Payment Confirmation"}),e.jsx(f,{type:"secondary",children:"Please check your phone and confirm the payment request"}),e.jsxs(y,{direction:"vertical",style:{width:"100%",marginTop:24},children:[e.jsx(w,{message:"Payment Details",description:e.jsxs(y,{direction:"vertical",children:[e.jsxs(f,{children:["Amount: ",l.getFieldValue("amount")," XAF"]}),e.jsxs(f,{children:["Phone: ",l.getFieldValue("phoneNumber")]}),e.jsxs(f,{children:["Transaction ID: ",c]})]}),type:"info",showIcon:!0}),e.jsxs("div",{style:{textAlign:"center",marginTop:16},children:[e.jsx(F,{size:"small"}),e.jsx(f,{type:"secondary",style:{marginLeft:8},children:"Checking payment status..."})]})]})]});case"timeout":return e.jsxs(y,{direction:"vertical",align:"center",style:{width:"100%"},children:[e.jsx(w,{message:"Payment Status Unclear",description:"We couldn't confirm your payment status. Would you like to check again?",type:"warning",showIcon:!0}),e.jsx(u,{type:"primary",onClick:U,loading:N,style:{marginTop:16},children:"Check Status Again"})]});case"failed":return e.jsxs(y,{direction:"vertical",align:"center",style:{width:"100%"},children:[e.jsx(w,{message:"Payment Failed",description:"Your payment could not be processed. Please try again.",type:"error",showIcon:!0}),e.jsx(u,{type:"primary",danger:!0,onClick:p,style:{marginTop:16},children:"Close"})]});default:return null}};return e.jsx(X,{open:n,onCancel:p,footer:i==="form"?[e.jsx(u,{onClick:p,children:"Cancel"},"cancel"),e.jsx(u,{type:"primary",onClick:()=>l.submit(),loading:b,children:d==="deposit"?"Deposit":"Withdraw"},"submit")]:null,width:500,title:d==="deposit"?"Mobile Money Deposit":"Withdraw Funds",children:V()})}const{Title:D,Text:H}=W;function ke(){const{user:n}=$(),[p,d]=r.useState(!1),[m,o]=r.useState(!1),{data:l,refetch:b}=g.wallet.findFirst.useQuery({where:{userId:n==null?void 0:n.id}}),{data:x}=g.transaction.findMany.useQuery({where:{userId:n==null?void 0:n.id},orderBy:{createdAt:"desc"}}),c=()=>{b(),k.success("Operation completed successfully")},j=s=>{k.error(s)},i=[{title:"Type",dataIndex:"type",key:"type"},{title:"Amount",dataIndex:"amount",key:"amount",render:s=>`XAF ${s}`},{title:"Status",dataIndex:"status",key:"status"},{title:"Date",dataIndex:"createdAt",key:"createdAt",render:s=>new Date(s).toLocaleDateString()}];return e.jsxs(Q,{children:[e.jsxs(q,{gutter:[24,24],children:[e.jsx(A,{xs:24,children:e.jsxs(T,{children:[e.jsx(D,{level:3,children:"Wallet Balance"}),e.jsxs(H,{strong:!0,style:{fontSize:24},children:["XAF ",(l==null?void 0:l.balance)||"0.00"]}),e.jsxs("div",{style:{marginTop:24},children:[e.jsx(u,{type:"primary",onClick:()=>o(!0),style:{marginRight:16},children:"Deposit Funds"}),e.jsx(u,{onClick:()=>d(!0),children:"Withdraw Funds"})]})]})}),e.jsx(A,{xs:24,children:e.jsxs(T,{children:[e.jsx(D,{level:3,children:"Transaction History"}),e.jsx(O,{columns:i,dataSource:x,rowKey:"id",pagination:{pageSize:10}})]})})]}),e.jsx(v,{isOpen:m,onClose:()=>o(!1),type:"deposit",onSuccess:c,onError:j}),e.jsx(v,{isOpen:p,onClose:()=>d(!1),type:"withdraw",onSuccess:c,onError:j})]})}export{ke as default};
